set(TURBO_JPEG_FAT_LIB_PATH "${JPEG_LIB_DIR}/${JPEG_LIBRARY}.a")
set(TURBO_JPEG_THIN_LIB_DIR "${3P_LIBRARY_OUTPUT_PATH}/${CMAKE_BUILD_TYPE}")
set(TURBO_JPEG_THIN_LIB_PATH "${TURBO_JPEG_THIN_LIB_DIR}/${JPEG_LIBRARY}.a")

add_custom_target(libturbojpeg_extract_from_fat_library ALL
  COMMAND
  mkdir -p ${TURBO_JPEG_THIN_LIB_DIR}
  COMMAND
  lipo -extract ${CMAKE_OSX_ARCHITECTURES} ${TURBO_JPEG_FAT_LIB_PATH} -o ${TURBO_JPEG_THIN_LIB_PATH}
)

add_library(${JPEG_LIBRARY} STATIC IMPORTED)

add_dependencies(${JPEG_LIBRARY} libturbojpeg_extract_from_fat_library)

set_property(TARGET ${JPEG_LIBRARY} PROPERTY IMPORTED_LOCATION TURBO_JPEG_THIN_LIB_PATH)

list(APPEND IMGCODECS_LIBRARIES TURBO_JPEG_THIN_LIB_PATH)

install(FILES ${TURBO_JPEG_THIN_LIB_PATH} DESTINATION "${OPENCV_3P_LIB_INSTALL_PATH}")

install(DIRECTORY "${JPEG_INCLUDE_DIR}/" DESTINATION "${OPENCV_INCLUDE_INSTALL_PATH}/opencv2/${JPEG_LIBRARY}")

set(OPENCV_MODULES_PUBLIC ${OPENCV_MODULES_PUBLIC} "${JPEG_LIBRARY}" CACHE INTERNAL "List of OpenCV modules marked for export")
